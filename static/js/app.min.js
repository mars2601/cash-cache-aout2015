!function e(t,i,n){function s(a,r){if(!i[a]){if(!t[a]){var l="function"==typeof require&&require;if(!r&&l)return l(a,!0);if(o)return o(a,!0);var u=new Error("Cannot find module '"+a+"'");throw u.code="MODULE_NOT_FOUND",u}var d=i[a]={exports:{}};t[a][0].call(d.exports,function(e){var i=t[a][1][e];return s(i?i:e)},d,d.exports,e,t,i,n)}return i[a].exports}for(var o="function"==typeof require&&require,a=0;a<n.length;a++)s(n[a]);return s}({1:[function(e,t,i){"use strict";var $=e("jquery"),n=e("fastclick"),s=e("./router");window.app.now=new Date,$(function(){n(document.body),console.log(window.app),console.log("ready."),window.app.router=new s,window.app.router.start()})},{"./router":4,fastclick:"fastclick",jquery:"jquery"}],2:[function(e,t,i){"use strict";var n=e("underscore"),s=e("backbone");s.$=e("jquery"),t.exports=s.Collection.extend({url:"/api/terminals",model:e("../models/terminal"),parse:function(e){return e.data}})},{"../models/terminal":3,backbone:"backbone",jquery:"jquery",underscore:"underscore"}],3:[function(e,t,i){"use strict";var n=e("underscore"),s=e("backbone");s.$=e("jquery"),t.exports=s.Model.extend({urlRoot:"/api/terminals",parse:function(e){return e.data&&e.url?e.data:e}})},{backbone:"backbone",jquery:"jquery",underscore:"underscore"}],4:[function(e,t,i){"use strict";var n=e("underscore"),s=e("backbone"),o=e("jeolok");s.$=e("jquery");var a=e("./views/main"),r=e("./views/header"),l=e("./collections/terminals"),u=e("./models/terminal"),d=e("./views/terminals-list"),c=e("./views/terminal-details"),m=e("./views/terminals-map"),p,g,f,y;t.exports=s.Router.extend({views:{},routes:{"terminals/list":"showTerminalsList","terminals/map":"showTerminalsMap","terminals/details/:id":"showTerminalDetails","":"showTerminalsList"},start:function(){console.log("Router:started"),(this.views.main=new a).render(),this.views.main.initHeader((this.views.header=new r).render()),o.getCurrentPosition({enableHighAccuracy:!0,timeout:11500},function(e,t){p=e||!t?{latitude:50.6833,longitude:5.55}:t.coords,window.app.currentPosition=p,s.history.start({pushState:!0})})},showTerminalsList:function(){console.log("showTerminalsList");var e=this;this.views.main.loading(!0);var t=new l;(this.views.list=new d(t)).collection.fetch({data:{latitude:p.latitude,longitude:p.longitude},success:function(){e.views.main.clearContent(),e.views.main.initList(e.views.list.render(y,p)),e.views.main.loading(!1,t.length+" résultats")}})},showTerminalsMap:function(){console.log("showTerminalsMap");var e=this;this.views.main.loading(!0);var t=new l;(this.views.map=new m(t,y,p)).collection.fetch({data:{latitude:p.latitude,longitude:p.longitude},success:function(){e.views.main.clearContent(),e.views.main.initMap(e.views.map.render(y,p)),e.views.main.loading(!1,t.length+" résultats")}})},showTerminalDetails:function(e){console.log("showTerminalDetails:",e);var t=this;this.views.main.loading(!0);var i=new u({id:e});(this.views.details=new c(i,y,p)).model.fetch({success:function(){t.views.main.clearContent(),t.views.main.initDetails(t.views.details.render(y,p)),t.views.main.loading(!1)}})}})},{"./collections/terminals":2,"./models/terminal":3,"./views/header":5,"./views/main":6,"./views/terminal-details":7,"./views/terminals-list":9,"./views/terminals-map":11,backbone:"backbone",jeolok:"jeolok",jquery:"jquery",underscore:"underscore"}],5:[function(e,t,i){"use strict";var n=e("underscore"),s=e("backbone"),$=e("jquery");s.$=e("jquery");var o;t.exports=s.View.extend({el:"<div />",constructor:function(){s.View.apply(this,arguments),console.log("HeaderView:init()"),o||(o=$("#tpl-header").remove().text())},events:{"click #reload":"reloadButtonClicked","click #back":"backButtonClicked","click #problems":"problemsButtonClicked"},render:function(){return this.$el.html(o),this.$status=this.$el.find("#status h3"),this},loading:function(e){this.$el.find("#status").toggleClass("loading",e)},getStatus:function(){return this.$status.text()},setStatus:function(e){this.$status.text(e)},reloadButtonClicked:function(e){e.preventDefault(),console.log("reloadButtonClicked"),s.history.loadUrl(s.history.fragment)},backButtonClicked:function(e){e.preventDefault(),console.log("backButtonClicked"),window.app.router.navigate("terminals/list",{trigger:!0})},problemsButtonClicked:function(e){e.preventDefault(),console.log("problemsButtonClicked"),$("#delete_terminal").length?($(".problems").hide(),$(".problems").children("a").remove()):$(".problems").append('<a href="#" id="delete_terminal">Pas de distributeur ici</a>').append('<a href="#" id="wrong_place_terminal">Mauvaise place sur la carte</a>').append('<a href="#" id="wrong_bank_terminal">Mauvaise banque</a>').append('<a href="#" id="double_terminal">Distributeur en double</a>').fadeIn().end()}})},{backbone:"backbone",jquery:"jquery",underscore:"underscore"}],6:[function(e,t,i){"use strict";var n=e("underscore"),s=e("backbone"),$=e("jquery");s.$=e("jquery"),t.exports=s.View.extend({el:"body",$el:$("body"),constructor:function(){s.View.apply(this,arguments),console.log("MainView:init()")},loading:function(e,t){e?(this._status=window.app.router.views.header.getStatus(),window.app.router.views.header.loading(!0),window.app.router.views.header.setStatus(t||"chargement...")):(window.app.router.views.header.loading(!1),window.app.router.views.header.setStatus(t))},initHeader:function(e){this.$el.find("#main").append(e.$el)},clearContent:function(){this.$el.find("#main section:not(#status)").remove()},initList:function(e){this.$el.find("#main").append(e.$el)},initMap:function(e){this.$el.find("#main").append(e.$el)},initDetails:function(e){this.$el.find("#main").append(e.$el)}})},{backbone:"backbone",jquery:"jquery",underscore:"underscore"}],7:[function(e,t,i){"use strict";var n=e("underscore"),s=e("backbone"),$=e("jquery"),o=e("jeyo-distans");s.$=e("jquery");var a,r=[],l,u,d,c=[],m,p;t.exports=s.View.extend({el:"<section />",constructor:function(e){s.View.apply(this,arguments),this.model=e,console.log("TerminalDetailsView:init()"),a||(a=$("#tpl-details").remove().text())},events:{"click .problems a#empty_terminal":"toggleEmptyState","click .problems a#delete_terminal":"deleteTerminal","click .problems a#wrong_place_terminal":"wrongPlaceTerminal","click .problems a#wrong_bank_terminal":"wrongBankTerminal","click .problems a#double_terminal":"doubleTerminal"},render:function(e,t){function i(t,i){var n=new google.maps.Marker({position:t,map:e,title:"My position",icon:i});r.push(n)}d={latitude:t.latitude,longitude:t.longitude},p=this.model.get("bank");var n={latitude:this.model.get("latitude"),longitude:this.model.get("longitude")},s=new google.maps.LatLngBounds;c=[],c.push(new google.maps.LatLng(n.latitude,n.longitude)),c.push(new google.maps.LatLng(d.latitude,d.longitude)),l={center:{lat:n.latitude,lng:n.longitude},zoom:16,mapTypeControl:!1,panControl:!1,zoomControl:!1,streetViewControl:!1,scaleControl:!0,styles:[{featureType:"landscape",stylers:[{saturation:-100},{lightness:65},{visibility:"on"}]},{featureType:"poi",stylers:[{saturation:-100},{lightness:51},{visibility:"simplified"}]},{featureType:"road.highway",stylers:[{saturation:-100},{visibility:"simplified"}]},{featureType:"road.arterial",stylers:[{saturation:-100},{lightness:30},{visibility:"on"}]},{featureType:"road.local",stylers:[{saturation:-100},{lightness:40},{visibility:"on"}]},{featureType:"transit",stylers:[{saturation:-100},{visibility:"simplified"}]},{featureType:"administrative.province",stylers:[{visibility:"off"}]},{featureType:"administrative.locality",stylers:[{visibility:"off"}]},{featureType:"administrative.neighborhood",stylers:[{visibility:"on"}]},{featureType:"water",elementType:"labels",stylers:[{visibility:"on"},{lightness:-25},{saturation:-100}]},{featureType:"water",elementType:"geometry",stylers:[{hue:"#ffff00"},{lightness:-25},{saturation:-97}]}]},e=new google.maps.Map(document.getElementById("gmap"),l);for(var u=0;u<c.length;u++)s.extend(c[u]);e.fitBounds(s),e.setZoom(e.getZoom()-1);var m="../../images/markers/me-marker.png",g=new google.maps.LatLng(d.latitude,d.longitude);i(g,m);var f="../../images/markers/terminal-marker.png",y=new google.maps.LatLng(n.latitude,n.longitude);i(y,f);var h=[y,g],n={latitude:this.model.get("latitude"),longitude:this.model.get("longitude")};return $(document).find(".status").css("display","none").end(),$("#gmap").removeAttr("class").end(),$("#header").find("#back").css("display","block").end(),$("#header").find("#problems").css("display","block").end(),this.$el.html(a).attr("id","details").show().find("h3").find("img").attr("src",p&&p.icon?"/images/banks/"+p.icon:"images/banks/unknown.png").attr("alt",p&&p.name?p.name:"Inconnu").end().find("span").css("color","#"+(p&&p.color?p.color:"333")).text(p&&p.name?p.name:"Inconnu").end().end().find("address").text(this.model.get("address")).end().find(".empty").toggle(this.model.get("empty")).end().find(".infos").css("position","relative").css("right","auto").css("top","auto").css("bottom","0").css("text-align","right").find("#distance").text(1e3*o(n,window.app.currentPosition)+"m").end().end().find(".problems").toggle(!this.model.get("empty")).css("display","none").end().find(".confirm_problem").hide(),this},toggleEmptyState:function(e){e.preventDefault();var t=this;this.model.set("empty",!1),this.model.save(null,{url:"/api/terminals/"+this.model.get("id")+"/empty",success:function(){t.$el.find("empty").show().end().find(".problems").hide()}})},deleteTerminal:function(e){console.log("deleteTerminal")},wrongPlaceTerminal:function(e){function t(e,t){var i=new google.maps.Marker({position:e,map:u,title:"My position",icon:t});r.push(i)}function i(e){for(var t=1;t<r.length;t++)r[t].setMap(e)}function n(){i(null)}console.log("wrongPlaceTerminal"),$(".problems").find("a").css("display","none").end().append('<p class="define_new_place">Clickez sur la carte pour positionner la banque.'),u=new google.maps.Map(document.getElementById("gmap"),l);for(var s=new google.maps.LatLngBounds,o=0;o<c.length;o++)s.extend(c[o]);u.fitBounds(s),u.setZoom(u.getZoom()-1);var a="../../images/markers/me-marker.png",p=new google.maps.LatLng(d.latitude,d.longitude);t(p,a);var g;g=this.model,google.maps.event.addListener(u,"click",function(e){var i="../../images/markers/terminal-marker.png";n(),t(p,"../../images/markers/me-marker.png"),t(e.latLng,i),m=e.latLng,$("#confirm-button").length||($("#demo").append('<a href="#" id="confirm-button" >Confirmer la nouvelle localisatn</a>'),$("#confirm-button").click(function(){g.set("latitude",m.D),g.set("longitude",m.k),console.log(g),console.log(m.D),console.log(m.k),g.save(null,{url:"/api/terminals/"+g.get("id")+"/reposition",success:function(){$(".problems").hide()},error:function(){console.log("aie")}})}))})},wrongBankTerminal:function(e){console.log("wrongBankTerminal")},doubleTerminal:function(e){console.log("doubleTerminal")}})},{backbone:"backbone","jeyo-distans":"jeyo-distans",jquery:"jquery",underscore:"underscore"}],8:[function(e,t,i){"use strict";var n=e("underscore"),s=e("backbone"),$=e("jquery");s.$=e("jquery");var o;t.exports=s.View.extend({el:"<li />",constructor:function(e){s.View.apply(this,arguments),this.model=e,o||(o=$("#tpl-result-list-elt").remove().text())},events:{"click a":"showTerminal"},render:function(){var e=this.model.get("bank");return this.$el.html(o).find("a").css("border-left","solid 6px #"+(e&&e.color?e.color:"333")).end().find("img").attr("src",e&&e.icon?"/images/banks/"+e.icon:"images/banks/unknown.png").attr("alt",e&&e.name?e.name:"Inconnu").end().find("strong").css("color","#"+(e&&e.color?e.color:"333")).text(e&&e.name?e.name:"Inconnu").end().find("span").text(1e3*parseFloat(this.model.get("distance"))+"m"),this},showTerminal:function(e){e.preventDefault(),window.app.router.navigate("terminals/details/"+this.model.get("id"),{trigger:!0})}})},{backbone:"backbone",jquery:"jquery",underscore:"underscore"}],9:[function(e,t,i){"use strict";var n=e("underscore"),s=e("backbone"),$=e("jquery");s.$=e("jquery");var o=e("./terminals-list-element"),a;t.exports=s.View.extend({el:"<section />",constructor:function(e){s.View.apply(this,arguments),this.collection=e,console.log("TerminalsListView:init()"),a||(a=$("#tpl-result-list").remove().text())},events:{"click a#see-all":"showMap"},render:function(e,t){var i={center:{lat:t.latitude,lng:t.longitude},zoom:16,mapTypeControl:!1,panControl:!1,zoomControl:!1,streetViewControl:!1,scaleControl:!0,styles:[{featureType:"landscape",stylers:[{saturation:-100},{lightness:65},{visibility:"on"}]},{featureType:"poi",stylers:[{saturation:-100},{lightness:51},{visibility:"simplified"}]},{featureType:"road.highway",stylers:[{saturation:-100},{visibility:"simplified"}]},{featureType:"road.arterial",stylers:[{saturation:-100},{lightness:30},{visibility:"on"}]},{featureType:"road.local",stylers:[{saturation:-100},{lightness:40},{visibility:"on"}]},{featureType:"transit",stylers:[{saturation:-100},{visibility:"simplified"}]},{featureType:"administrative.province",stylers:[{visibility:"off"}]},{featureType:"administrative.locality",stylers:[{visibility:"off"}]},{featureType:"administrative.neighborhood",stylers:[{visibility:"on"}]},{featureType:"water",elementType:"labels",stylers:[{visibility:"on"},{lightness:-25},{saturation:-100}]},{featureType:"water",elementType:"geometry",stylers:[{hue:"#ffff00"},{lightness:-25},{saturation:-97}]}]};e=new google.maps.Map(document.getElementById("gmap"),i),$("#header").find("#back").css("display","none").end(),$("#gmap").attr("class","blured").end(),$("#header").find("#problems").css("display","none").end(),this.$el.attr("id","result").html(a).find("#see-all").css("display","block");var n=this.$el.find("ul");return this.collection.each(function(e){new o(e).render().$el.appendTo(n)}),this},showMap:function(e){console.log("showMapClick"),e.preventDefault(),window.app.router.navigate("terminals/map",{trigger:!0})}})},{"./terminals-list-element":8,backbone:"backbone",jquery:"jquery",underscore:"underscore"}],10:[function(e,t,i){"use strict";var n=e("underscore"),s=e("backbone"),$=e("jquery"),o=e("jeyo-distans");s.$=e("jquery");var a;t.exports=s.View.extend({el:"<section />",constructor:function(e){s.View.apply(this,arguments),this.model=e,a||(a=$("#tpl-map-elt").remove().text())},render:function(e,t,i){function n(t,n){var s=new google.maps.Marker({position:t,map:e,title:"My position",icon:n});google.maps.event.addListener(s,"click",function(){window.app.router.navigate("terminals/details/"+o,{trigger:!0})}),i.push(s)}var s=this.model.get("bank"),o=this.model.get("id"),a={latitude:this.model.get("latitude"),longitude:this.model.get("longitude")};t.push(new google.maps.LatLng(a.latitude,a.longitude));var r=new google.maps.LatLngBounds,l="../images/markers/terminal-marker.png",u=new google.maps.LatLng(a.latitude,a.longitude);n(u,l);for(var d=0;d<t.length;d++)r.extend(t[d]);return e.fitBounds(r),e.setZoom(e.getZoom()-1),this},toggleEmptyState:function(e){e.preventDefault();var t=this;this.model.set("empty",!1),this.model.save(null,{url:"/api/terminals/"+this.model.get("id")+"/empty",success:function(){t.$el.find("empty").show().end().find(".problems").hide()}})}})},{backbone:"backbone","jeyo-distans":"jeyo-distans",jquery:"jquery",underscore:"underscore"}],11:[function(e,t,i){"use strict";var n=e("underscore"),s=e("backbone"),$=e("jquery"),o=e("jeyo-distans");s.$=e("jquery");var a=e("./terminals-map-element"),r,l=[],u=[];t.exports=s.View.extend({el:"<section />",constructor:function(e){s.View.apply(this,arguments),this.collection=e,console.log("TerminalsMapView:init()"),r||(r=$("#tpl-map").remove().text())},events:{},render:function(e,t){function i(t,i){var n=new google.maps.Marker({position:t,map:e,title:"My position",icon:i});u.push(n)}$("#header").find("#back").css("display","block").end(),$("#header").find("#problems").css("display","none").end(),$(document).find(".status").css("display","block").end(),$("#gmap").removeAttr("class").end();var n={latitude:t.latitude,longitude:t.longitude},s={center:{lat:n.latitude,lng:n.longitude},zoom:16,mapTypeControl:!1,panControl:!1,zoomControl:!1,streetViewControl:!1,scaleControl:!0,styles:[{featureType:"landscape",stylers:[{saturation:-100},{lightness:65},{visibility:"on"}]},{featureType:"poi",stylers:[{saturation:-100},{lightness:51},{visibility:"simplified"}]},{featureType:"road.highway",stylers:[{saturation:-100},{visibility:"simplified"}]},{featureType:"road.arterial",stylers:[{saturation:-100},{lightness:30},{visibility:"on"}]},{featureType:"road.local",stylers:[{saturation:-100},{lightness:40},{visibility:"on"}]},{featureType:"transit",stylers:[{saturation:-100},{visibility:"simplified"}]},{featureType:"administrative.province",stylers:[{visibility:"off"}]},{featureType:"administrative.locality",stylers:[{visibility:"off"}]},{featureType:"administrative.neighborhood",stylers:[{visibility:"on"}]},{featureType:"water",elementType:"labels",stylers:[{visibility:"on"},{lightness:-25},{saturation:-100}]},{featureType:"water",elementType:"geometry",stylers:[{hue:"#ffff00"},{lightness:-25},{saturation:-97}]}]};e=new google.maps.Map(document.getElementById("gmap"),s);var o="../images/markers/me-marker.png",r=new google.maps.LatLng(n.latitude,n.longitude);return i(r,o),l.push(new google.maps.LatLng(n.latitude,n.longitude)),this.collection.each(function(t){new a(t).render(e,l,u)}),this},toggleEmptyState:function(e){e.preventDefault();var t=this;this.model.set("empty",!1),this.model.save(null,{url:"/api/terminals/"+this.model.get("id")+"/empty",success:function(){t.$el.find("empty").show().end().find(".problems").hide()}})}})},{"./terminals-map-element":10,backbone:"backbone","jeyo-distans":"jeyo-distans",jquery:"jquery",underscore:"underscore"}]},{},[1]);