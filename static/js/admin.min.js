!function e(t,n,i){function o(r,a){if(!n[r]){if(!t[r]){var l="function"==typeof require&&require;if(!a&&l)return l(r,!0);if(s)return s(r,!0);var d=new Error("Cannot find module '"+r+"'");throw d.code="MODULE_NOT_FOUND",d}var u=n[r]={exports:{}};t[r][0].call(u.exports,function(e){var n=t[r][1][e];return o(n?n:e)},u,u.exports,e,t,n,i)}return n[r].exports}for(var s="function"==typeof require&&require,r=0;r<i.length;r++)o(i[r]);return o}({1:[function(e,t,n){"use strict";var $=e("jquery"),i=e("fastclick"),o=e("./router");window.app.now=new Date,$(function(){i(document.body),window.app.router=new o,window.app.router.start()})},{"./router":4,fastclick:"fastclick",jquery:"jquery"}],2:[function(e,t,n){"use strict";var i=e("underscore"),o=e("backbone");o.$=e("jquery"),t.exports=o.Collection.extend({url:"/api/terminals",model:e("../models/terminal"),parse:function(e){return e.data}})},{"../models/terminal":3,backbone:"backbone",jquery:"jquery",underscore:"underscore"}],3:[function(e,t,n){"use strict";var i=e("underscore"),o=e("backbone");o.$=e("jquery"),t.exports=o.Model.extend({urlRoot:"/api/terminals",parse:function(e){return e.data&&e.url?e.data:e}})},{backbone:"backbone",jquery:"jquery",underscore:"underscore"}],4:[function(e,t,n){"use strict";var i=e("underscore"),o=e("backbone"),s=e("jeolok");o.$=e("jquery");var r=e("./views/main"),a=e("./views/header"),l=e("./views/terminals-list"),d=e("./views/terminal-details"),u=e("./collections/terminals"),c=e("./models/terminal"),m;t.exports=o.Router.extend({views:{},routes:{admin:"showAdminTerminalsList","admin/list":"showAdminTerminalsList","admin/list/:radius":"showAdminTerminalsList","admin/details/:id":"showAdminTerminalDetails"},start:function(){console.log("AdminRouter:started"),(this.views.main=new r).render(),this.views.main.initAdminHeader((this.views.header=new a).render()),s.getCurrentPosition({enableHighAccuracy:!0,timeout:11500},function(e,t){m=e||!t?{latitude:50.6833,longitude:5.55}:t.coords,window.app.currentPosition=m,o.history.start({pushState:!0})})},showAdminTerminalsList:function(e){console.log("showAdminTerminalsList"),console.log(m.latitude);var t=this;this.views.main.loading(!0);var n=new u;null==e&&(e=5),console.log(e),(this.views.list=new l(m,n,e)).collection.fetch({data:{latitude:m.latitude,longitude:m.longitude,radius:e},success:function(){t.views.main.clearContent(),t.views.main.initAdminList(t.views.list.render()),t.views.main.loading(!1,"Liste des distributeurs")}})},showAdminTerminalDetails:function(e){console.log("showAdminTerminalDetails");var t=this;this.views.main.loading(!0);var n=new c({id:e});(this.views.details=new d(m,n)).model.fetch({success:function(){t.views.main.clearContent(),t.views.main.initAdminDetails(t.views.details.render()),t.views.main.loading(!1,"DÃ©tails sur le distributeur")}})}})},{"./collections/terminals":2,"./models/terminal":3,"./views/header":5,"./views/main":6,"./views/terminal-details":7,"./views/terminals-list":9,backbone:"backbone",jeolok:"jeolok",jquery:"jquery",underscore:"underscore"}],5:[function(e,t,n){"use strict";var i=e("underscore"),o=e("backbone"),$=e("jquery");o.$=e("jquery");var s;t.exports=o.View.extend({el:"<div />",constructor:function(){o.View.apply(this,arguments),console.log("AdminHeaderView:init()"),s||(s=$("#tpl-header").remove().text())},events:{"click #reload":"reloadList","click #back":"backList"},render:function(){return this.$el.html(s),this.$status=this.$el.find("#status h2"),this},loading:function(e){this.$el.find("#status").toggleClass("loading",e)},getStatus:function(){return this.$status.text()},setStatus:function(e){this.$status.text(e)},reloadList:function(e){e.preventDefault(),o.history.loadUrl(o.history.fragment)},backList:function(e){e.preventDefault(),window.app.router.navigate("admin",{trigger:!0})}})},{backbone:"backbone",jquery:"jquery",underscore:"underscore"}],6:[function(e,t,n){"use strict";var i=e("underscore"),o=e("backbone"),$=e("jquery");o.$=e("jquery"),t.exports=o.View.extend({el:"body",$el:$("body"),constructor:function(){o.View.apply(this,arguments),console.log("AdminMainView:init()")},loading:function(e,t){e?(this._status=window.app.router.views.header.getStatus(),window.app.router.views.header.loading(!0),window.app.router.views.header.setStatus(t||"chargement...")):(window.app.router.views.header.loading(!1),window.app.router.views.header.setStatus(t))},initAdminHeader:function(e){this.$el.find("#main").append(e.$el)},clearContent:function(){this.$el.find("#main section:not(#status)").remove()},initAdminList:function(e){this.$el.find("#main").append(e.$el)},initAdminDetails:function(e){this.$el.find("#main").append(e.$el)}})},{backbone:"backbone",jquery:"jquery",underscore:"underscore"}],7:[function(e,t,n){"use strict";var i=e("underscore"),o=e("backbone"),$=e("jquery"),s=e("jeyo-distans");o.$=e("jquery");var r;t.exports=o.View.extend({el:"<section />",constructor:function(e,t){o.View.apply(this,arguments),this.model=t,this.position=e,console.log("TerminalDetailsView:init()"),r||(r=$("#tpl-details").remove().text())},events:{"click #emptyTerminal":"toggleEmptyState","click #fullTerminal":"toggleFullState","click #wrongAddress":"changeInfos","click #wrongBank":"changeInfos","submit #changeAddress":"changeAddress","submit #changeBank":"changeBank"},render:function(){$("#back").show();var e=this.model.get("bank"),t={latitude:this.model.get("latitude"),longitude:this.model.get("longitude")};return this.$el.html(r).find(".details").find("h3").find("img").attr("src",e&&e.icon?"/images/banks/"+e.icon:"images/banks/unknown.png").attr("alt",e&&e.name?e.name:"Inconnu").end().find("span").css("color","#"+(e&&e.color?e.color:"333")).text(e&&e.name?e.name:"Inconnu").end().end().find("address").text(this.model.get("address")).end().find(".empty").toggle(this.model.get("empty")).end().find(".infos").css("position","relative").css("right","auto").css("top","auto").css("bottom","0").css("text-align","right").find("> span").text(1e3*s(t,window.app.currentPosition)+"m").end().end(),1==this.model.get("empty")?this.$el.find("#empty").show().end().find("#full").hide().end().find("#fullTerminal").show().end().find("#emptyTerminal").hide().end():this.$el.find("#empty").hide().end().find("#full").show().end().find("#fullTerminal").hide().end().find("#emptyTerminal").show().end(),this.create(),this},create:function(){function e(e){var t=new google.maps.Geocoder;t.geocode({latLng:e},function(t,n){if(n==google.maps.GeocoderStatus.OK){var i=t[0].formatted_address,s=e.G,r=e.K;d.get("model").save(null,{url:"/api/terminals/"+d.get("model").get("id")+"/"+i+"/"+s+"/"+r+"/changeposition",success:function(){o.history.loadUrl(o.history.fragment)}})}})}var t=new google.maps.LatLng(this.position.latitude,this.position.longitude),n={zoom:2,zoomControl:!0,scrollwheel:!1,center:t,mapTypeId:google.maps.MapTypeId.ROADMAP},i=new google.maps.Map(document.getElementById("gmap"),n),s=new google.maps.Marker({position:t,title:"Ma position",map:i,icon:"/images/markers/me-marker.png",zIndex:2}),r=this.model.get("bank"),a=this.model.get("latitude"),l=this.model.get("longitude"),d=new google.maps.Marker({position:new google.maps.LatLng(a,l),title:this.model.get("bank").name,map:i,icon:"/images/markers/terminal-marker.png",animation:google.maps.Animation.BOUNCE,zIndex:1,draggable:!0});d.set("model",this.model),google.maps.event.addListener(d,"dragstart",function(){d.setAnimation(null)}),google.maps.event.addListener(d,"dragend",function(){e(d.getPosition())})},toggleEmptyState:function(e){e.preventDefault(),this.model.set("empty",!0),this.model.save(null,{url:"/api/terminals/"+this.model.get("id")+"/empty",success:function(){$("#empty").show(),$("#full").hide(),$("#fullTerminal").css("display","block"),$("#emptyTerminal").hide()}})},toggleFullState:function(e){e.preventDefault(),this.model.set("empty",!1),console.log(this.model),this.model.save(null,{url:"/api/terminals/"+this.model.get("id")+"/full",success:function(){$("#empty").hide(),$("#full").show(),$("#fullTerminal").hide(),$("#emptyTerminal").show()},error:function(e,t){console.log("Error!"),console.log(t)}})},changeInfos:function(e){e.preventDefault(),console.log(e.target.id),"wrongAddress"==e.target.id?($(".formulaire").toggle(),$(".changeBank").toggle()):($(".formulaire").toggle(),$(".changeAddress").toggle())},changeAddress:function(e){e.preventDefault();var t=$("#address").val();this.model.save(null,{url:"/api/terminals/"+this.model.get("id")+"/"+t+"/changeaddress",success:function(){o.history.loadUrl(o.history.fragment)},error:function(e,t){console.log("Error!"),console.log(t)}})},changeBank:function(e){e.preventDefault();var t=$("#bankSelect").val();this.model.save(null,{url:"/api/terminals/"+this.model.get("id")+"/"+t+"/changebank",success:function(){o.history.loadUrl(o.history.fragment)},error:function(e,t){console.log("Error!"),console.log(t)}})}})},{backbone:"backbone","jeyo-distans":"jeyo-distans",jquery:"jquery",underscore:"underscore"}],8:[function(e,t,n){"use strict";var i=e("underscore"),o=e("backbone"),$=e("jquery");o.$=e("jquery");var s;t.exports=o.View.extend({el:"<li />",constructor:function(e){o.View.apply(this,arguments),this.model=e,s||(s=$("#tpl-list-terminals").remove().text())},events:{"click a":"showTerminal"},render:function(){var e=this.model.get("bank");return this.$el.html(s).find(".details").css("border-left","solid 6px #"+(e&&e.color?e.color:"333")).find("img").attr("src",e&&e.icon?"/images/banks/"+e.icon:"images/banks/unknown.png").attr("alt",e&&e.name?e.name:"Inconnu").end().find("strong").css("color","#"+(e&&e.color?e.color:"333")).text(e&&e.name?e.name:"Inconnu").end().find("span").text(1e3*parseFloat(this.model.get("distance"))+"m"),this},showTerminal:function(e){e.preventDefault(),window.app.router.navigate("admin/details/"+this.model.get("id"),{trigger:!0})}})},{backbone:"backbone",jquery:"jquery",underscore:"underscore"}],9:[function(e,t,n){"use strict";var i=e("underscore"),o=e("backbone"),$=e("jquery");o.$=e("jquery");var s,r=e("./terminals-list-element");t.exports=o.View.extend({el:"<section />",constructor:function(e,t,n){o.View.apply(this,arguments),this.collection=t,this.position=e,this.radius=n;var i=n;console.log("AdminTerminalsListView:init()"),console.log(this.collection),s||(s=$("#tpl-list").remove().text())},events:{"click #show":"showList","click #hide":"hideList","change #radius":"changeRadius"},render:function(){return $("#back").hide(),this.$el.html(s).find("#radius").attr("value",this.radius).end().find("#radiusValue").text(this.radius+"km").end().find("#hide").hide().end(),this.create(),this},create:function(){console.log("addBounds");var e=new google.maps.LatLng(this.position.latitude,this.position.longitude),t=Math.round(14-Math.log(this.radius)/Math.LN2),n={zoom:t-1,zoomControl:!0,scrollwheel:!1,center:e,mapTypeId:google.maps.MapTypeId.ROADMAP},i=new google.maps.Map(document.getElementById("gmap"),n),o=new google.maps.Marker({position:e,title:"Ma position",map:i,icon:"/images/markers/me-marker.png",zIndex:2,draggable:!0});google.maps.event.addListener(o,"dragend",function(){console.log(o.getPosition())});var s=new google.maps.Circle({strokeColor:"#000c20",strokeOpacity:.8,strokeWeight:2,fillColor:"#ffffff",fillOpacity:.4,map:i,center:e,radius:1e3*this.radius});console.log(this.collection),this.collection.each(function(e){var t=e,n=t.get("bank"),o=t.get("latitude"),s=t.get("longitude"),r=new google.maps.Marker({position:new google.maps.LatLng(o,s),map:i,icon:"/images/markers/terminal-marker.png",zIndex:1})})},showList:function(e){e.preventDefault(),this.$el.html(s).find("#radius").attr("value",this.radius).end().find("#radiusValue").text(this.radius+"km").end().find("#show").hide().end().find("#hide").show().end().find("ul").show().end();var t=this.$el.find("ul");this.collection.each(function(e){new r(e).render().$el.appendTo(t)})},hideList:function(e){e.preventDefault(),this.$el.html(s).find("#radius").attr("value",this.radius).end().find("#radiusValue").text(this.radius+"km").end().find("#show").show().end().find("#hide").hide().end().find("ul").hide().end()},changeRadius:function(e){e.preventDefault();var t=$("#radius").val();window.app.router.navigate("admin/list/"+t,{trigger:!0})}})},{"./terminals-list-element":8,backbone:"backbone",jquery:"jquery",underscore:"underscore"}]},{},[1]);